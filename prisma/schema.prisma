generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  name               String?
  settings           Json?               @default("{}")
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  accounts           Account[]
  checklistTemplates ChecklistTemplate[]
  notes              Note[]

  @@map("users")
}

model Account {
  id             String   @id @default(uuid())
  userId         String
  name           String
  initialBalance Decimal  @db.Decimal(18, 2)
  currency       String   @default("USD")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades         Trade[]

  @@index([userId])
  @@map("accounts")
}

model Trade {
  id             String          @id @default(uuid())
  accountId      String
  symbol         String
  assetClass     AssetClass      @default(CRYPTO)
  side           TradeSide       @default(LONG)
  entryPrice     Decimal         @db.Decimal(18, 8)
  exitPrice      Decimal?        @db.Decimal(18, 8)
  volume         Decimal         @db.Decimal(18, 8)
  fees           Decimal?        @default(0) @db.Decimal(18, 8)
  stopLoss       Decimal?        @db.Decimal(18, 8)
  takeProfit     Decimal?        @db.Decimal(18, 8)
  status         TradeStatus     @default(OPEN)
  entryTime      DateTime        @default(now())
  exitTime       DateTime?
  emotionEntry   Emotion?
  emotionExit    Emotion?
  notes          String?
  lessonsLearned String?
  pnl            Decimal?        @db.Decimal(18, 8)
  riskReward     Decimal?        @db.Decimal(5, 2)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  attachments    Attachment[]
  checklist      ChecklistItem[]
  tags           TradeTag[]
  noteLinks      TradeNoteLink[]
  account        Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([status])
  @@index([symbol])
  @@index([entryTime])
  @@map("trades")
}

model Tag {
  id     String     @id @default(uuid())
  name   String     @unique
  type   TagType
  color  String?    @default("#6366f1")
  trades TradeTag[]

  @@map("tags")
}

model TradeTag {
  tradeId String
  tagId   String
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  trade   Trade  @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@id([tradeId, tagId])
  @@map("trade_tags")
}

model Attachment {
  id       String            @id @default(uuid())
  tradeId  String
  imageUrl String
  context  AttachmentContext @default(ENTRY)
  caption  String?
  trade    Trade             @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@index([tradeId])
  @@map("attachments")
}

model ChecklistItem {
  id      String  @id @default(uuid())
  tradeId String
  text    String
  checked Boolean @default(false)
  trade   Trade   @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@index([tradeId])
  @@map("checklist_items")
}

model ChecklistTemplate {
  id     String   @id @default(uuid())
  userId String
  name   String   @default("Discipline Checklist")
  items  String[]
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("checklist_templates")
}

model Note {
  id        String   @id @default(uuid())
  userId    String
  title     String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  sourceLinks NoteLink[]      @relation("sourceNote")
  targetLinks NoteLink[]      @relation("targetNote")
  tradeLinks  TradeNoteLink[]

  @@index([userId])
  @@map("notes")
}

model NoteLink {
  id           String @id @default(uuid())
  sourceNoteId String
  targetNoteId String

  sourceNote Note @relation("sourceNote", fields: [sourceNoteId], references: [id], onDelete: Cascade)
  targetNote Note @relation("targetNote", fields: [targetNoteId], references: [id], onDelete: Cascade)

  @@unique([sourceNoteId, targetNoteId])
  @@index([sourceNoteId])
  @@index([targetNoteId])
  @@map("note_links")
}

model TradeNoteLink {
  id      String @id @default(uuid())
  tradeId String
  noteId  String

  trade Trade @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  note  Note  @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([tradeId, noteId])
  @@index([tradeId])
  @@index([noteId])
  @@map("trade_note_links")
}

enum AssetClass {
  CRYPTO
  STOCKS
  FOREX
  FUTURES
  OPTIONS
}

enum TradeSide {
  LONG
  SHORT
}

enum TradeStatus {
  OPEN
  CLOSED
}

enum Emotion {
  NEUTRAL
  ANXIOUS
  OVERCONFIDENT
  FEARFUL
  GREEDY
  DISCIPLINED
  FOMO
  REVENGE
}

enum TagType {
  STRATEGY
  MISTAKE
  SETUP
  MARKET_CONDITION
}

enum AttachmentContext {
  ENTRY
  EXIT
  ANALYSIS
}
